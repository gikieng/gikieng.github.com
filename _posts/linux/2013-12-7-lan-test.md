---
layout: post
categories: linux
title: "局域网共享网络实验"
---
##用linux共享上网设置##

环境：一台单网卡的linux系统机器（本次实验使用的是fedora的发行版），n台windows和linux系统的机器，一个集线器。<br>


背景：宿舍上网需要每个人都有一个帐号，并且限定一个帐号对应一个mac地址和ip地址。


目的：通过linux共享上网设置，将其它电脑（不需要学校的帐号）也带入网络。</br>


方法：利用linux机器做个ＤＨＣＰ服务，用集线器做成一个局域网。再利用ＮＡＴ转发此网段的ip请求。

理论知识：linux iptables规则；linux单网卡绑定多ip；NAT网络地址转换（Network Address Translation），也叫做网络掩蔽或者IP掩蔽； 动态主机设置协议（Dynamic Host Configuration Protocol, DHCP)。

***
查看本机使用的网卡名；
`#ifconfig`

        lo: flags=73<UP,LOOPBACK,RUNNING>  mtu 65536
        inet 127.0.0.1  netmask 255.0.0.0
        inet6 ::1  prefixlen 128  scopeid 0x10<host>
        loop  txqueuelen 0  (Local Loopback)
        RX packets 1918  bytes 132800 (129.6 KiB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 1918  bytes 132800 (129.6 KiB)
        TX errors 0  dropped 0 overruns 0  carrier 0  >collisions 0

        p2p1: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
        inet 222.27.149.39  netmask 255.255.255.0  broadcast 0.0.0.0
        inet6 2001:250:7801:c10:203:25ff:fe4b:d63a  prefixlen 128  scopeid 0x0<global>
        inet6 fe80::203:25ff:fe4b:d63a  prefixlen 64  scopeid 0x20<link>
        ether 00:03:25:4b:d6:3a  txqueuelen 1000  (Ethernet)
        RX packets 101563  bytes 66897853 (63.7 MiB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 45244  bytes 7534193 (7.1 MiB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

可知我在用的网卡名为　p2p1。lo为内环网，必须存在，这里不用管。

设置单网卡绑定多ip。在`/etc/sysconfig/network-scripts/`目录下新建一个名为ifcfg-p2p1:0`的方件。内容样例为：

    DEVICE=p2p1:0
    BOOTPROTO=static
    BROADCAST=192.168.0.255
    IPADDR=192.168.0.3
    NETMASK=255.255.255.0
    NETWORK=192.168.1.0
    ONBOOT=yes

停用网卡: `#sudo ifdown p2p1`

起用网卡: `#sudo ifup p2p1`

再次查看网卡信息:

    lo: flags=73<UP,LOOPBACK,RUNNING>  mtu 65536
        inet 127.0.0.1  netmask 255.0.0.0
        inet6 ::1  prefixlen 128  scopeid 0x10<host>
        loop  txqueuelen 0  (Local Loopback)
        RX packets 2995  bytes 229168 (223.7 KiB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 2995  bytes 229168 (223.7 KiB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

    p2p1: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
        inet 222.27.149.39  netmask 255.255.255.0  broadcast 222.27.149.255
        inet6 fe80::203:25ff:fe4b:d63a  prefixlen 64  scopeid 0x20<link>
        ether 00:03:25:4b:d6:3a  txqueuelen 1000  (Ethernet)
        RX packets 14369563  bytes 14691453943 (13.6 GiB)
        RX errors 0  dropped 16  overruns 0  frame 0
        TX packets 14304443  bytes 14554243607 (13.5 GiB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

    p2p1:0: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
        inet 192.168.0.3  netmask 255.255.255.0  broadcast 192.168.0.255
        ether 00:03:25:4b:d6:3a  txqueuelen 1000  (Ethernet)

看到多了一个p2p1:0的网卡信息，ip地址为192.168.0.3。

在其它机器上设置ip地址为192.168.0.* *为除３外1~254之间的一个数。不能为３，因为已经linux机器占用了。设置网关地址为192.168.0.3，掩码为２４或者255.255.255.0，dns跟linux机器一样。

到这能够在局域网内发现到linux机器了，但是还是不能上网。

进行ＮＡＴ地址转发了。p2p1的地址对外，p2p1:0的地址对局域网。

设置ip_tables规则脚本nat.sh：
  
    echo "1" >/proc/sys/net/ipv4/ip_forward
    modprobe ip_tables
    modprobe ip_nat_ftp
    modprobe ip_nat_irc
    modprobe ip_conntrack
    modprobe ip_conntrack_ftp
    modprobe ip_conntrack_irc
    /sbin/iptables -F
    /sbin/iptables -X
    /sbin/iptables -Z
    /sbin/iptables -F -t nat
    /sbin/iptables -X -t nat
    /sbin/iptables -Z -t nat
    /sbin/iptables -P INPUT DROP
    /sbin/iptables -P OUTPUT ACCEPT
    /sbin/iptables -P FORWARD ACCEPT
    /sbin/iptables -t nat -P PREROUTING ACCEPT
    /sbin/iptables -t nat -P POSTROUTING ACCEPT
    /sbin/iptables -t nat -A POSTROUTING -o p2p1 -s 192.168.1.0/24　-j MASQUERADE
    iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
    iptables -A OUTPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

运行nat.sh。

设置dns。<br>
`gvim  /etc/resolv.conf`<br>

    # Generated by NetworkManager
    nameserver 202.118.176.8
    nameserver 202.97.224.6
这个dns是我们学校提供的。

如果没有出错，那么到此其它的机器只要设置好网络就可以上网了。

如果发现到linux机器上不了网，其它的机器能够上网，参照iptable规则开启一些服务。

利用dhcpd实现动态分配ip，这个在一个寢室没有多大的用处，但是还是感受一下：

安装：`sudo yum install dhcpd`。

打开/etc/dhcpd.conf文件进行编辑，如果没有这个文件，那么可以自己建一个。

修改配置dhcpd.conf文件。样本：



    #租约
    default-lease-time 6000;
    max-lease-time 72000;
    #dns不更新
    ddns-update-style none;
    #本地认证
    authoritative;
    #监听网段
    shared-network 24{
    subnet 192.168.0.0 netmask 255.255.255.0
        {
        #192.168.0.３刚才设置对内的ip。
        option routers 192.168.0.2;
        #分配的ip段。
        range 192.168.1.2 192.168.1.59;
        }
    }

其它一些权限什么的配置可以参照`/usr/share/doc/dhcp/下的dhcpd.conf.example`。

设置配置文件路径及监听网卡:</br>     `sudo gvim /etc/systemd/system/dhcpd.service`


修改[Service]为
`
ExecStart=/usr/sbin/dhcpd -f -cf /etc/dhcpd.conf -user dhcpd -group dhcpd --no-pid p2p1:0`

参考文件为/etc/sysconfig/dhcpd。

启动服务：<br>`sudo systemctl restart dhcpd.service`或者`sudo dhcpd restart`<br>查看服务信息：<br>`sudo cat /var/log/messages|grep dhcpd`或者`sudo dhcpd status`。如果有错误就无法启动。

其它机器设置ip获取方式为自动。

实验完成。
***
如果有什么问题可以参考鸟哥的私房菜《防火牆與 NAT 伺服器 》[1]: http://linux.vbird.org/linux_server/0250simple_firewall.php　和《網路參數控管者： DHCP 伺服器》[1]:http://linux.vbird.org/linux_server/0340dhcp.php]
